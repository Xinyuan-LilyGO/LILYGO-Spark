name: Build/release

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: '手动编译目标'
        required: true
        default: all
        type: choice
        options:
          - all
          - mac
          - win
          - linux

permissions:
  contents: write

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build:compile

  build-mac:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.target == 'mac' || inputs.target == 'all' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build:compile
      - run: npm run build:mac:all
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Rename and Filter macOS artifacts
        run: |
          mkdir -p final-artifacts
          ls -R release/
          # 规范命名并只保留 dmg
          cp release/*-arm64.dmg final-artifacts/LILYGO-Spark-0.1.0-macOS-arm64.dmg || true
          cp release/*-universal.dmg final-artifacts/LILYGO-Spark-0.1.0-macOS-universal.dmg || true
          # 如果有默认命名的也处理一下
          cp release/LILYGO\ Spark-0.1.0.dmg final-artifacts/LILYGO-Spark-0.1.0-macOS-x64.dmg || true
      - uses: actions/upload-artifact@v4
        with:
          name: macOS-artifacts
          path: final-artifacts/*.dmg

  build-win:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.target == 'win' || inputs.target == 'all' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build:compile
      - run: npm run build:win:all
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Rename Windows artifacts
        shell: bash
        run: |
          mkdir -p final-artifacts
          ls -R release/
          # 规范命名
          cp release/*arm64*.exe final-artifacts/LILYGO-Spark-0.1.0-windows-setup-arm64.exe || true
          cp release/*x64*.exe final-artifacts/LILYGO-Spark-0.1.0-windows-setup-x64.exe || true
          # 处理可能不带架构名的默认文件 (通常是 x64)
          if [ ! -f final-artifacts/LILYGO-Spark-0.1.0-windows-setup-x64.exe ]; then
            cp release/*.exe final-artifacts/LILYGO-Spark-0.1.0-windows-setup-x64.exe || true
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: Windows-artifacts
          path: final-artifacts/*.exe

  build-linux:
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.target == 'linux' || inputs.target == 'all' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build:compile
      - run: sudo apt-get update && sudo apt-get install -y rpm snapd
      - run: npm run build:linux:all
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Rename Linux artifacts
        run: |
          mkdir -p final-artifacts
          ls -R release/
          # AppImage
          cp release/*arm64.AppImage final-artifacts/LILYGO-Spark-0.1.0-linux-arm64.AppImage || true
          cp release/*x86_64.AppImage final-artifacts/LILYGO-Spark-0.1.0-linux-x64.AppImage || true
          # 处理可能不带架构名的默认文件 (通常是 x64)
          if [ ! -f final-artifacts/LILYGO-Spark-0.1.0-linux-x64.AppImage ]; then
            cp release/*.AppImage final-artifacts/LILYGO-Spark-0.1.0-linux-x64.AppImage || true
          fi
          
          # deb
          cp release/*arm64.deb final-artifacts/LILYGO-Spark-0.1.0-linux-arm64.deb || true
          cp release/*amd64.deb final-artifacts/LILYGO-Spark-0.1.0-linux-x64.deb || true
      - uses: actions/upload-artifact@v4
        with:
          name: Linux-artifacts
          path: final-artifacts/*

  release:
    needs: [build-mac, build-win, build-linux]
    if: ${{ github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: Prepare files
        run: |
          mkdir -p upload
          find dist/ -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" \) -exec cp {} upload/ \;
          ls -lh upload/

      - name: Generate Tag Name
        id: tag
        run: |
          TIME_STR=$(date -d "+8 hours" +'%Y%m%d-%H%M%S')
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "release_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag_prefix=manual-${TIME_STR}-${SHA_SHORT}" >> $GITHUB_OUTPUT
            echo "release_name=Manual Build ${TIME_STR} (${SHA_SHORT})" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "tag_prefix=build-${TIME_STR}-${SHA_SHORT}" >> $GITHUB_OUTPUT
            echo "release_name=Build ${TIME_STR} (${SHA_SHORT})" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          # 先用临时 tag 创建，成功后再改名
          tag_name: ${{ steps.tag.outputs.tag_prefix || steps.tag.outputs.tag_name }}-uploading
          name: ${{ steps.tag.outputs.release_name }}
          body: |
            Automated build for commit ${{ github.sha }}
            Triggered by: ${{ github.event_name }}
          prerelease: ${{ steps.tag.outputs.is_prerelease }}
          files: upload/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Finalize Tag (Success)
        if: success() && github.ref != 'refs/tags/v*'
        run: |
          OLD_TAG="${{ steps.tag.outputs.tag_prefix }}-uploading"
          NEW_TAG="${{ steps.tag.outputs.tag_prefix }}-ok"
          # 使用 API 修改 release 的 tag
          gh release edit "$OLD_TAG" --tag "$NEW_TAG"
          # 删除旧 tag
          git push origin ":refs/tags/$OLD_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Finalize Tag (Failure)
        if: failure() && github.ref != 'refs/tags/v*'
        run: |
          OLD_TAG="${{ steps.tag.outputs.tag_prefix }}-uploading"
          NEW_TAG="${{ steps.tag.outputs.tag_prefix }}-failed"
          gh release edit "$OLD_TAG" --tag "$NEW_TAG"
          git push origin ":refs/tags/$OLD_TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old builds
        if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
        run: |
          RELEASES_TO_DELETE=$(gh release list --limit 100 | grep -E "^(build-|manual-)" | awk '{print $1}' | tail -n +21)
          if [ -n "$RELEASES_TO_DELETE" ]; then
            for TAG in $RELEASES_TO_DELETE; do
              gh release delete "$TAG" --yes --cleanup-tag
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}